This is the final version, combining changes from both branches.
